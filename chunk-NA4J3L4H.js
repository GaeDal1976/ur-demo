import{a as U}from"./chunk-4SM2VG5F.js";import{$ as X,Aa as Z,Ba as tt,Ca as et,Da as ot,Ea as it,Fa as rt,Ga as st,Ha as R,Ia as nt,Ja as ct,S as B,T as G,U as x,V as W,W as Q,X as V,Y as $,Z as q,_ as z,p as k,q as T,va as J,ya as K,za as Y}from"./chunk-KXXKTX2T.js";import{c as l}from"./chunk-737PEWWY.js";import{D as b,F as C,z as p}from"./chunk-54NO2V2Q.js";import{t as M}from"./chunk-KODN66SN.js";import{Aa as u,Bb as j,C as D,Cb as N,Db as H,Fa as d,K as h,Ka as g,O as v,Xa as E,a as m,b as S,db as f,eb as _,i as y,ia as w,j as O,nb as F,q as A,r as L,xb as P}from"./chunk-P6AE7GFT.js";var at="Cerca Cliente",lt=[J,Z,K,tt,Y,et,ot,it,rt,st],I={validators:[],controls:[Q,B,x,V,$,q,X,z]};var pt=(()=>{class s{options$=new O({});setOptions(t,e){let o=S(m({},this.options$.value),{[t]:e});this.options$.next(o)}autocomplitionOptions(t){return this.subscribeAutocomplition(t,this.subscribeField.bind(this))}subscribeAutocomplition(t,e){let o={};t.forEach(c=>o[c]=e(c));let n=Object.keys(o),r=Object.values(o);return L(r).pipe(A(c=>Object.fromEntries(n.map((i,a)=>[i,c[a]]))))}subscribeField(t){return this.options$.pipe(A(e=>e[t]),D())}static \u0275fac=function(e){return new(e||s)};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var Pt=(()=>{class s{clienetService;store;route;type;select=new w;visible=!0;searchForm;optionsFrom;selectedRows;table;filterdTableData;destroySubject=new y;constructor(t,e,o){this.clienetService=t,this.store=e,this.route=o}ngOnInit(){this.selectedRows=new Array,this.table={label:at,headers:lt,data:[]},this.filterdTableData=[],this.subscribeAutocomplition(),this.searchForm=nt(I,this.route.snapshot.queryParams);let t=this.searchForm.controls.find(e=>e.name===p);t&&(this.type?(t.default=this.type,t.disabled=!0,this.onFilterChange({})):t.default=T.CapoGruppo)}onFormEvent({type:t,payload:e}){switch(t){case R.FormChange:this.onFilterChange(e);break;case R.FormSubmit:this.onFilterSubmit(e);break;case R.FormAutocomplete:this.optionsFrom[e.name]||this.fetchAutoCompletion(e.name)}}onFilterChange(t){let e=!!this.type&&!t[p];this.type&&(t[p]=this.type);let o=()=>{this.searchForm.controls.forEach(i=>i.default=t[i.name]),this.searchForm=m({},this.searchForm)},n=this.searchForm.controls.find(i=>i.name==C),r=this.searchForm.controls.find(i=>i.name==b),c=t[p];if(c!=T.Cliente&&r&&n&&(this.searchForm.controls=this.searchForm.controls.filter(i=>![C,b].includes(i.name)),e=!0),c==T.Cliente&&!r&&!n){let i=this.searchForm.controls.findIndex(a=>a.name==p);i!=-1&&(this.searchForm.controls=[...this.searchForm.controls.slice(0,i+1),G,W,...this.searchForm.controls.slice(i+1)]),e=!0}e&&o()}onFilterSubmit(t){if(!t){this.filterdTableData=this.table.data;return}this.fetchClients(t)}fetchAutoCompletion(t){this.clienetService.autoComplete(t).pipe(h(this.destroySubject)).subscribe({next:e=>{this.store.setOptions(t,e),l.print("fetchAutoCompletion","result",t)},error:e=>{l.print("fetchAutoCompletion","error",t)},complete:()=>{l.print("fetchAutoCompletion","complete",t)}})}subscribeAutocomplition(){let t=I.controls.filter(e=>e.autocomplete).map(e=>e.name);this.store.autocomplitionOptions([...t,C,b]).pipe(h(this.destroySubject)).subscribe(e=>{this.optionsFrom=e})}fetchClients(t){let e={params:t,"X-UNIPOL-REQUESTID":crypto.randomUUID()};this.clienetService.getCliente(e).pipe(h(this.destroySubject)).subscribe({next:o=>{this.table.data=o;let n=Object.keys(t),r=i=>{for(let a of n)if(t[a]!=null&&t[a]!=""&&t[a]!=i[a])return!1;return!0},c=this.table.data.filter(r);this.filterdTableData=c,l.print("getScontiCostruttore","result",o)},error:o=>{l.print("getScontiCostruttore","error",o)},complete:()=>{l.print("getScontiCostruttore","complete")}})}ngOnDestroy(){this.destroySubject.next(),this.destroySubject.complete()}static \u0275fac=function(e){return new(e||s)(d(U),d(pt),d(M))};static \u0275cmp=g({type:s,selectors:[["search-client"]],inputs:{type:"type"},outputs:{select:"select"},decls:6,vars:7,consts:[[1,"cerca-cliente"],["clearButton","Rimuovi filtri","buttonLabel","Cerca",3,"dispacther","form","options"],[1,"action","flex","flex-row","flex-wrap","justify-end","gap-2","p-2"],["type","button",1,"ur-button","primary",3,"click","disabled"],[3,"selectedRowsChange","withoutExport","headers","data","selectedRows"]],template:function(e,o){e&1&&(f(0,"div",0)(1,"app-form",1),F("dispacther",function(r){return o.onFormEvent(r)}),_(),f(2,"div",2)(3,"button",3),F("click",function(){return o.select.emit(o.selectedRows)}),P(4," Seleziona "),_()(),f(5,"app-table",4),H("selectedRowsChange",function(r){return N(o.selectedRows,r)||(o.selectedRows=r),r}),_()()),e&2&&(u(),E("form",o.searchForm)("options",o.optionsFrom),u(2),E("disabled",!o.selectedRows.length),u(2),E("withoutExport",!0)("headers",o.table.headers)("data",o.filterdTableData),j("selectedRows",o.selectedRows))},dependencies:[ct,k],encapsulation:2})}return s})();export{Pt as a};
